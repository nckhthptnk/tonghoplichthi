<!doctype html>
<html lang="vi" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tổng Hợp Lịch Kiểm Tra</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loading-spinner {
            border: 2px solid #f3f4f6;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 font-sans">
  <div class="min-h-full"><!-- Header -->
   <header class="gradient-bg text-white py-8 px-6">
    <div class="max-w-6xl mx-auto text-center">
     <h1 id="page-title" class="text-4xl md:text-5xl font-bold mb-3">Tổng Hợp Lịch Kiểm Tra</h1>
     <p id="page-subtitle" class="text-xl opacity-90">Quản lý và tổng hợp lịch kiểm tra từ tkbnkhoahung.github.io và nckhthptnk.github.io</p>
     <div class="mt-6 flex justify-center items-center gap-4 text-sm">
      <div class="flex items-center gap-2">
       <div class="w-3 h-3 bg-blue-300 rounded-full"></div><span>Lịch Kiểm Tra (tkbnkhoahung)</span>
      </div>
      <div class="flex items-center gap-2">
       <div class="w-3 h-3 bg-green-300 rounded-full"></div><span>Lịch Thi Tại Lớp (nckhthptnk)</span>
      </div>
     </div>
    </div>
   </header>
   <main class="max-w-6xl mx-auto px-6 py-8"><!-- Form thêm mới -->
    <div class="bg-white rounded-2xl shadow-xl p-8 mb-8 card-hover">
     <div class="flex items-center gap-3 mb-6">
      <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center">
       <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
       </svg>
      </div>
      <h2 class="text-2xl font-bold text-gray-800">Thêm Lịch Kiểm Tra Mới</h2>
     </div>
     <form id="add-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"><!-- Nguồn dữ liệu -->
      <div class="lg:col-span-1"><label for="source" class="block text-sm font-semibold text-gray-700 mb-2"> <span class="flex items-center gap-2"> 🌐 Nguồn Dữ Liệu <span class="text-red-500">*</span> </span> </label> <select id="source" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors"> <option value="">Chọn nguồn dữ liệu</option> <option value="tkbnkhoahung">📚 Lịch Kiểm Tra (tkbnkhoahung.github.io)</option> <option value="nckhthptnk">📝 Lịch Thi Tại Lớp (nckhthptnk.github.io)</option> </select>
      </div><!-- Khối lớp -->
      <div class="lg:col-span-1"><label for="grade" class="block text-sm font-semibold text-gray-700 mb-2"> <span class="flex items-center gap-2"> 🎓 Khối Lớp <span class="text-red-500">*</span> </span> </label> <select id="grade" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors"> <option value="">Chọn khối lớp</option> <option value="khoi10">📖 Khối 10</option> <option value="khoi11">📘 Khối 11</option> <option value="khoi12">📙 Khối 12</option> </select>
      </div><!-- Môn học -->
      <div class="lg:col-span-1"><label for="subject" class="block text-sm font-semibold text-gray-700 mb-2"> <span class="flex items-center gap-2"> 📚 Môn Học <span class="text-red-500">*</span> </span> </label> <input type="text" id="subject" placeholder="Ví dụ: Toán, Văn, Anh..." class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
      </div><!-- Ngày kiểm tra -->
      <div class="md:col-span-1"><label for="date" class="block text-sm font-semibold text-gray-700 mb-2"> <span class="flex items-center gap-2"> 📅 Ngày Kiểm Tra <span class="text-red-500">*</span> </span> </label> <input type="date" id="date" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
      </div><!-- Giờ kiểm tra -->
      <div class="md:col-span-1"><label for="time" class="block text-sm font-semibold text-gray-700 mb-2"> <span class="flex items-center gap-2"> ⏰ Giờ Kiểm Tra </span> </label> <input type="time" id="time" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
      </div><!-- Nội dung chi tiết -->
      <div class="md:col-span-2 lg:col-span-3"><label for="content" class="block text-sm font-semibold text-gray-700 mb-2"> <span class="flex items-center gap-2"> 📝 Nội Dung Chi Tiết </span> </label> <textarea id="content" rows="3" placeholder="Nhập nội dung chi tiết về bài kiểm tra, chương trình, phạm vi..." class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors resize-none"></textarea>
      </div><!-- Ghi chú -->
      <div class="md:col-span-2 lg:col-span-3"><label for="notes" class="block text-sm font-semibold text-gray-700 mb-2"> <span class="flex items-center gap-2"> 💡 Ghi Chú Thêm </span> </label> <textarea id="notes" rows="2" placeholder="Ghi chú thêm, lưu ý đặc biệt..." class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors resize-none"></textarea>
      </div><!-- Nút thêm -->
      <div class="md:col-span-2 lg:col-span-3"><button type="submit" id="add-button" class="w-full md:w-auto bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-4 px-8 rounded-xl transition-all duration-200 flex items-center justify-center gap-3 shadow-lg hover:shadow-xl"> <span id="add-button-text">Thêm Lịch Kiểm Tra</span>
        <div id="add-loading" class="loading-spinner hidden"></div></button>
      </div>
     </form>
    </div><!-- Bộ lọc và thống kê -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8"><!-- Bộ lọc -->
     <div class="lg:col-span-3 bg-white rounded-2xl shadow-lg p-6">
      <h3 id="filter-title" class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">🔍 Bộ Lọc</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4"><select id="filter-source" class="px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors"> <option value="">🌐 Tất cả nguồn</option> <option value="tkbnkhoahung">📚 tkbnkhoahung</option> <option value="nckhthptnk">📝 nckhthptnk</option> </select> <select id="filter-grade" class="px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors"> <option value="">🎓 Tất cả khối</option> <option value="khoi10">📖 Khối 10</option> <option value="khoi11">📘 Khối 11</option> <option value="khoi12">📙 Khối 12</option> </select> <input type="text" id="filter-subject" placeholder="🔍 Tìm theo môn học..." class="px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
      </div>
     </div><!-- Thống kê -->
     <div class="bg-gradient-to-br from-indigo-500 to-purple-600 text-white rounded-2xl shadow-lg p-6">
      <h3 class="text-lg font-bold mb-3">📊 Thống Kê</h3>
      <div class="space-y-2">
       <div class="flex justify-between"><span class="text-sm opacity-90">Tổng cộng:</span> <span id="total-count" class="font-bold">0</span>
       </div>
       <div class="flex justify-between"><span class="text-sm opacity-90">Hiển thị:</span> <span id="filtered-count" class="font-bold">0</span>
       </div>
      </div>
     </div>
    </div><!-- Danh sách lịch kiểm tra -->
    <div class="bg-white rounded-2xl shadow-xl p-8">
     <div class="flex justify-between items-center mb-6">
      <h3 class="text-2xl font-bold text-gray-800 flex items-center gap-3">📋 Danh Sách Lịch Kiểm Tra</h3>
      <div class="flex items-center gap-2"><button id="export-wallpaper" class="px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white rounded-lg text-sm font-medium transition-colors flex items-center gap-2"> 📱 Xuất Hình Nền </button> <button id="sort-date" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium transition-colors"> 📅 Sắp xếp theo ngày </button>
      </div>
     </div>
     <div id="schedule-list" class="space-y-4">
      <div id="empty-state" class="text-center py-16 text-gray-500">
       <div class="text-8xl mb-6">
        📚
       </div>
       <h4 class="text-2xl font-semibold mb-2">Chưa có lịch kiểm tra nào</h4>
       <p class="text-lg mb-4">Hãy thêm lịch kiểm tra đầu tiên từ hai nguồn dữ liệu!</p>
       <div class="flex justify-center gap-4 text-sm"><span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full">tkbnkhoahung.github.io</span> <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full">nckhthptnk.github.io</span>
       </div>
      </div>
     </div>
    </div>
   </main>
  </div>
  <script>
        let allSchedules = [];
        let isLoading = false;
        let sortByDate = true;

        // Cấu hình mặc định
        const defaultConfig = {
            page_title: "Tổng Hợp Lịch Kiểm Tra",
            page_subtitle: "Quản lý và tổng hợp lịch kiểm tra từ tkbnkhoahung.github.io và nckhthptnk.github.io",
            add_button_text: "Thêm Lịch Kiểm Tra",
            filter_title: "Bộ Lọc"
        };

        // Data handler cho SDK
        const dataHandler = {
            onDataChanged(data) {
                allSchedules = data || [];
                renderScheduleList();
                updateStatistics();
            }
        };

        // Element SDK functions
        async function onConfigChange(config) {
            const pageTitle = config.page_title || defaultConfig.page_title;
            const pageSubtitle = config.page_subtitle || defaultConfig.page_subtitle;
            const addButtonText = config.add_button_text || defaultConfig.add_button_text;
            const filterTitle = config.filter_title || defaultConfig.filter_title;

            document.getElementById('page-title').textContent = pageTitle;
            document.getElementById('page-subtitle').textContent = pageSubtitle;
            document.getElementById('add-button-text').textContent = addButtonText;
            document.getElementById('filter-title').textContent = `🔍 ${filterTitle}`;
        }

        function mapToCapabilities(config) {
            return {
                recolorables: [
                    {
                        get: () => config.primary_color || "#4f46e5",
                        set: (value) => {
                            if (window.elementSdk) {
                                window.elementSdk.setConfig({ primary_color: value });
                            }
                        }
                    },
                    {
                        get: () => config.secondary_color || "#7c3aed",
                        set: (value) => {
                            if (window.elementSdk) {
                                window.elementSdk.setConfig({ secondary_color: value });
                            }
                        }
                    },
                    {
                        get: () => config.background_color || "#f8fafc",
                        set: (value) => {
                            if (window.elementSdk) {
                                window.elementSdk.setConfig({ background_color: value });
                            }
                        }
                    }
                ],
                borderables: [],
                fontEditable: {
                    get: () => config.font_family || "Inter",
                    set: (value) => {
                        if (window.elementSdk) {
                            window.elementSdk.setConfig({ font_family: value });
                        }
                    }
                },
                fontSizeable: {
                    get: () => config.font_size || 16,
                    set: (value) => {
                        if (window.elementSdk) {
                            window.elementSdk.setConfig({ font_size: value });
                        }
                    }
                }
            };
        }

        function mapToEditPanelValues(config) {
            return new Map([
                ["page_title", config.page_title || defaultConfig.page_title],
                ["page_subtitle", config.page_subtitle || defaultConfig.page_subtitle],
                ["add_button_text", config.add_button_text || defaultConfig.add_button_text],
                ["filter_title", config.filter_title || defaultConfig.filter_title]
            ]);
        }

        // Khởi tạo SDK
        async function initializeApp() {
            try {
                if (window.dataSdk) {
                    const result = await window.dataSdk.init(dataHandler);
                    if (!result.isOk) {
                        console.error("Lỗi khởi tạo Data SDK");
                    }
                }

                if (window.elementSdk) {
                    window.elementSdk.init({
                        defaultConfig,
                        onConfigChange,
                        mapToCapabilities,
                        mapToEditPanelValues
                    });
                }
            } catch (error) {
                console.error("Lỗi khởi tạo ứng dụng:", error);
            }
        }

        // Thêm lịch kiểm tra mới
        async function addSchedule(event) {
            event.preventDefault();
            
            if (isLoading) return;

            const source = document.getElementById('source').value;
            const grade = document.getElementById('grade').value;
            const subject = document.getElementById('subject').value.trim();
            const date = document.getElementById('date').value;
            const time = document.getElementById('time').value;
            const content = document.getElementById('content').value.trim();
            const notes = document.getElementById('notes').value.trim();

            if (!source || !grade || !subject || !date) {
                showMessage("Vui lòng điền đầy đủ thông tin bắt buộc (nguồn, khối, môn học, ngày)!", "error");
                return;
            }

            if (allSchedules.length >= 999) {
                showMessage("Đã đạt giới hạn tối đa 999 mục. Vui lòng xóa một số mục trước!", "error");
                return;
            }

            setLoading(true);

            const newSchedule = {
                id: Date.now().toString(),
                source: source,
                grade: grade,
                subject: subject,
                date: date,
                time: time || "",
                content: content,
                notes: notes,
                created_at: new Date().toISOString()
            };

            if (window.dataSdk) {
                const result = await window.dataSdk.create(newSchedule);
                if (result.isOk) {
                    document.getElementById('add-form').reset();
                    showMessage("✅ Đã thêm lịch kiểm tra thành công!", "success");
                } else {
                    showMessage("❌ Có lỗi xảy ra khi thêm lịch kiểm tra!", "error");
                }
            }

            setLoading(false);
        }

        // Xóa lịch kiểm tra
        async function deleteSchedule(schedule) {
            if (window.dataSdk) {
                const result = await window.dataSdk.delete(schedule);
                if (result.isOk) {
                    showMessage("🗑️ Đã xóa lịch kiểm tra!", "success");
                } else {
                    showMessage("❌ Có lỗi xảy ra khi xóa!", "error");
                }
            }
        }

        // Hiển thị danh sách
        function renderScheduleList() {
            const container = document.getElementById('schedule-list');
            const emptyState = document.getElementById('empty-state');
            
            const filteredSchedules = getFilteredSchedules();
            
            if (filteredSchedules.length === 0) {
                emptyState.style.display = 'block';
                container.innerHTML = '';
                container.appendChild(emptyState);
                return;
            }

            emptyState.style.display = 'none';
            
            // Sắp xếp
            if (sortByDate) {
                filteredSchedules.sort((a, b) => new Date(a.date) - new Date(b.date));
            }
            
            container.innerHTML = filteredSchedules.map(schedule => {
                const sourceInfo = getSourceInfo(schedule.source);
                const gradeInfo = getGradeInfo(schedule.grade);
                const isUpcoming = new Date(schedule.date) >= new Date().setHours(0,0,0,0);
                
                return `
                    <div class="border-2 border-gray-100 rounded-xl p-6 card-hover ${isUpcoming ? 'bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-200' : 'bg-gray-50'} fade-in">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-3">
                                    <span class="bg-${sourceInfo.color}-100 text-${sourceInfo.color}-800 px-3 py-1 rounded-full text-sm font-semibold flex items-center gap-1">
                                        ${sourceInfo.icon} ${sourceInfo.name}
                                    </span>
                                    <span class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm font-semibold flex items-center gap-1">
                                        ${gradeInfo.icon} ${gradeInfo.name}
                                    </span>
                                    ${isUpcoming ? '<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-medium">Sắp tới</span>' : '<span class="bg-gray-100 text-gray-600 px-2 py-1 rounded-full text-xs font-medium">Đã qua</span>'}
                                </div>
                                
                                <h4 class="text-xl font-bold text-gray-800 mb-2 flex items-center gap-2">
                                    📚 ${schedule.subject}
                                </h4>
                                
                                <div class="flex flex-wrap items-center gap-4 text-sm text-gray-600 mb-3">
                                    <span class="flex items-center gap-1">
                                        📅 ${formatDate(schedule.date)}
                                    </span>
                                    ${schedule.time ? `<span class="flex items-center gap-1">⏰ ${schedule.time}</span>` : ''}
                                </div>
                                
                                ${schedule.content ? `
                                    <div class="bg-white rounded-lg p-3 mb-3 border border-gray-200">
                                        <p class="text-gray-700 text-sm leading-relaxed">${schedule.content}</p>
                                    </div>
                                ` : ''}
                                
                                ${schedule.notes ? `
                                    <div class="bg-yellow-50 rounded-lg p-3 border border-yellow-200">
                                        <p class="text-yellow-800 text-sm leading-relaxed">💡 ${schedule.notes}</p>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <button onclick="confirmDelete('${schedule.id}')" class="text-red-500 hover:text-red-700 p-3 rounded-xl hover:bg-red-50 transition-all duration-200 ml-4">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Lọc dữ liệu
        function getFilteredSchedules() {
            const sourceFilter = document.getElementById('filter-source').value;
            const gradeFilter = document.getElementById('filter-grade').value;
            const subjectFilter = document.getElementById('filter-subject').value.toLowerCase();

            return allSchedules.filter(schedule => {
                const matchSource = !sourceFilter || schedule.source === sourceFilter;
                const matchGrade = !gradeFilter || schedule.grade === gradeFilter;
                const matchSubject = !subjectFilter || schedule.subject.toLowerCase().includes(subjectFilter);
                
                return matchSource && matchGrade && matchSubject;
            });
        }

        // Xác nhận xóa
        function confirmDelete(scheduleId) {
            const schedule = allSchedules.find(s => s.id === scheduleId);
            if (!schedule) return;

            const button = event.target.closest('button');
            const originalContent = button.innerHTML;
            
            button.innerHTML = `
                <div class="flex flex-col items-center gap-2 text-xs">
                    <span class="text-red-600 font-semibold">Xác nhận xóa?</span>
                    <div class="flex gap-1">
                        <button onclick="executeDelete('${scheduleId}')" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs font-medium">Xóa</button>
                        <button onclick="cancelDelete(this)" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-2 py-1 rounded text-xs font-medium">Hủy</button>
                    </div>
                </div>
            `;
            
            button.dataset.originalContent = originalContent;
        }

        function executeDelete(scheduleId) {
            const schedule = allSchedules.find(s => s.id === scheduleId);
            if (schedule) {
                deleteSchedule(schedule);
            }
        }

        function cancelDelete(cancelButton) {
            const mainButton = cancelButton.closest('button').parentElement.parentElement;
            mainButton.innerHTML = mainButton.dataset.originalContent;
        }

        // Utility functions
        function getSourceInfo(source) {
            const sources = {
                'tkbnkhoahung': { name: 'tkbnkhoahung', icon: '📚', color: 'blue' },
                'nckhthptnk': { name: 'nckhthptnk', icon: '📝', color: 'green' }
            };
            return sources[source] || { name: source, icon: '🌐', color: 'gray' };
        }

        function getGradeInfo(grade) {
            const grades = {
                'khoi10': { name: 'Khối 10', icon: '📖' },
                'khoi11': { name: 'Khối 11', icon: '📘' },
                'khoi12': { name: 'Khối 12', icon: '📙' }
            };
            return grades[grade] || { name: grade, icon: '🎓' };
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const today = new Date();
            const diffTime = date - today.setHours(0,0,0,0);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            let dateStr = date.toLocaleDateString('vi-VN', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            if (diffDays === 0) {
                dateStr += ' (Hôm nay)';
            } else if (diffDays === 1) {
                dateStr += ' (Ngày mai)';
            } else if (diffDays > 1 && diffDays <= 7) {
                dateStr += ` (Còn ${diffDays} ngày)`;
            }
            
            return dateStr;
        }

        function updateStatistics() {
            const filteredSchedules = getFilteredSchedules();
            document.getElementById('total-count').textContent = allSchedules.length;
            document.getElementById('filtered-count').textContent = filteredSchedules.length;
        }

        function setLoading(loading) {
            isLoading = loading;
            const button = document.getElementById('add-button');
            const spinner = document.getElementById('add-loading');
            
            if (loading) {
                button.disabled = true;
                button.classList.add('opacity-75', 'cursor-not-allowed');
                spinner.classList.remove('hidden');
            } else {
                button.disabled = false;
                button.classList.remove('opacity-75', 'cursor-not-allowed');
                spinner.classList.add('hidden');
            }
        }

        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-6 right-6 px-6 py-4 rounded-xl shadow-2xl z-50 max-w-sm ${
                type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
            } fade-in`;
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.style.opacity = '0';
                messageDiv.style.transform = 'translateX(100%)';
                setTimeout(() => messageDiv.remove(), 300);
            }, 3000);
        }

        // Xuất hình nền điện thoại
        function exportWallpaper() {
            const filteredSchedules = getFilteredSchedules();
            const upcomingSchedules = filteredSchedules
                .filter(schedule => new Date(schedule.date) >= new Date().setHours(0,0,0,0))
                .sort((a, b) => new Date(a.date) - new Date(b.date))
                .slice(0, 8); // Lấy tối đa 8 lịch sắp tới

            // Tạo canvas với tỷ lệ điện thoại (9:16)
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Kích thước cho điện thoại (1080x1920)
            canvas.width = 1080;
            canvas.height = 1920;

            // Gradient background
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#667eea');
            gradient.addColorStop(0.5, '#764ba2');
            gradient.addColorStop(1, '#f093fb');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Overlay pattern
            ctx.globalAlpha = 0.1;
            for (let i = 0; i < 50; i++) {
                ctx.beginPath();
                ctx.arc(Math.random() * canvas.width, Math.random() * canvas.height, Math.random() * 100, 0, 2 * Math.PI);
                ctx.fillStyle = '#ffffff';
                ctx.fill();
            }
            ctx.globalAlpha = 1;

            // Header
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 80px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('📚 LỊCH KIỂM TRA', canvas.width / 2, 150);
            
            ctx.font = '50px Arial';
            ctx.fillText('Tuần này', canvas.width / 2, 220);

            // Ngày hiện tại
            const today = new Date();
            ctx.font = '40px Arial';
            ctx.fillText(today.toLocaleDateString('vi-VN', { 
                weekday: 'long', 
                day: 'numeric', 
                month: 'long' 
            }), canvas.width / 2, 280);

            let yPos = 380;
            const itemHeight = 180;
            const maxWidth = canvas.width - 120;

            if (upcomingSchedules.length === 0) {
                // Không có lịch
                ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                ctx.fillRect(60, yPos, canvas.width - 120, 200);
                
                ctx.fillStyle = '#666666';
                ctx.font = '60px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('🎉', canvas.width / 2, yPos + 80);
                ctx.font = '45px Arial';
                ctx.fillText('Không có kiểm tra nào!', canvas.width / 2, yPos + 140);
                ctx.font = '35px Arial';
                ctx.fillText('Thời gian rảnh rỗi 😊', canvas.width / 2, yPos + 180);
            } else {
                // Hiển thị lịch kiểm tra
                upcomingSchedules.forEach((schedule, index) => {
                    if (yPos + itemHeight > canvas.height - 100) return;

                    // Background cho mỗi item
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
                    ctx.fillRect(60, yPos, canvas.width - 120, itemHeight - 20);
                    
                    // Border trái màu theo nguồn
                    const sourceColor = schedule.source === 'tkbnkhoahung' ? '#3b82f6' : '#10b981';
                    ctx.fillStyle = sourceColor;
                    ctx.fillRect(60, yPos, 8, itemHeight - 20);

                    // Nội dung
                    ctx.fillStyle = '#1f2937';
                    ctx.textAlign = 'left';
                    
                    // Môn học
                    ctx.font = 'bold 45px Arial';
                    const subjectText = schedule.subject.length > 15 ? schedule.subject.substring(0, 15) + '...' : schedule.subject;
                    ctx.fillText(subjectText, 100, yPos + 50);
                    
                    // Ngày và giờ
                    ctx.font = '35px Arial';
                    ctx.fillStyle = '#6b7280';
                    const dateText = new Date(schedule.date).toLocaleDateString('vi-VN', { 
                        weekday: 'short', 
                        day: 'numeric', 
                        month: 'short' 
                    });
                    const timeText = schedule.time ? ` • ${schedule.time}` : '';
                    ctx.fillText(`📅 ${dateText}${timeText}`, 100, yPos + 90);
                    
                    // Khối lớp
                    const gradeText = getGradeInfo(schedule.grade).name;
                    ctx.fillText(`🎓 ${gradeText}`, 100, yPos + 130);

                    yPos += itemHeight;
                });
            }

            // Footer
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.font = '30px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Tạo bởi Tổng Hợp Lịch Kiểm Tra', canvas.width / 2, canvas.height - 60);
            ctx.fillText('tkbnkhoahung.github.io • nckhthptnk.github.io', canvas.width / 2, canvas.height - 20);

            // Tải xuống
            canvas.toBlob(function(blob) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `lich-kiem-tra-${today.toISOString().split('T')[0]}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showMessage('📱 Đã xuất hình nền thành công! Kiểm tra thư mục tải xuống.', 'success');
            }, 'image/png');
        }

        // Event listeners
        document.getElementById('add-form').addEventListener('submit', addSchedule);
        
        document.getElementById('filter-source').addEventListener('change', () => {
            renderScheduleList();
            updateStatistics();
        });
        
        document.getElementById('filter-grade').addEventListener('change', () => {
            renderScheduleList();
            updateStatistics();
        });
        
        document.getElementById('filter-subject').addEventListener('input', () => {
            renderScheduleList();
            updateStatistics();
        });

        document.getElementById('sort-date').addEventListener('click', () => {
            sortByDate = !sortByDate;
            const button = document.getElementById('sort-date');
            button.textContent = sortByDate ? '📅 Sắp xếp theo ngày' : '🔤 Sắp xếp theo tên';
            renderScheduleList();
        });

        document.getElementById('export-wallpaper').addEventListener('click', exportWallpaper);

        // Khởi tạo ứng dụng
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9967d28fe6b1c7d2',t:'MTc2MTc5NDkwNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
